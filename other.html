<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEURA MURGUI</title>
    <link rel="icon" href="assets/faviribbon.ico">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            font-family: "Times New Roman", Times, serif;
            font-size: 11pt;
            line-height: 1.1;
            overflow-x: hidden;
            scroll-behavior: smooth;
            text-transform: uppercase;
        }

        body.lock-scroll {
            overflow: hidden !important;
            height: 100vh !important;
        }

        /* --- BACKGROUND CANVAS (A) --- */
        #ivy-canvas {
             position: fixed; /* Mantiene el fondo quieto mientras haces scroll */
             top: 0;
             left: 0;
             width: 100vw;
             height: 100vh;
             z-index: -1; /* Detr谩s de todo */
             pointer-events: none; /* No interfiere con clics */
             image-rendering: pixelated;
             opacity: 0.5 ;
        }

        /* SISTEMA DE FILTROS Y OTROS ESTILOS */
        #filters {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
            list-style: none;
            padding: 0;
            margin: 0;
            text-transform: lowercase;
        }

        #filters li {
            margin: 10px 0;
            font-size: 11pt;
            cursor: pointer;
            color: black;
        }

        #filters li:hover, #filters li.active {
            color: #ff0000;
            text-shadow: 1px 1px 1px #ff0000, 1px -1px 1px #ff0000, -1px 1px 1px #ff0000, -1px -1px 1px #ff0000;
        }

        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            font-size: 54pt;
            font-weight: 700;
            pointer-events: none;
            color: #ffffff;
            mix-blend-mode: difference;
            text-transform: none;
            max-width: 1000px;
            line-height: 1.1;
        }

        .info-desc {
            font-size: 14pt;
            font-weight: 400;
            margin-top: 8px;
            color: #ffffff;
        }

        #back-to-top {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            font-size: 11pt;
            color: black;
            cursor: pointer;
            text-transform: uppercase;
            background: #ff0000;
            border: none;
            padding: 5px 10px;
            font-family: inherit;
        }

        header {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        nav li { list-style: none; margin: 0; padding: 0; }
        a { text-decoration: none; color: rgb(255, 0, 0); }
        a:hover { color: #ffffff; background-color: rgb(110, 108, 108); }

        .container-chaos {
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
            width: 100%;
        }

        .work-item {
            position: absolute;
            width: 320px;
            z-index: 10;
            opacity: 0; 
            cursor: zoom-in;
        }

        .work-item.ui-draggable-dragging {
            cursor: grabbing !important;
            transition: none !important;
        }

        .thumb {
            width: 100%;
            display: block;
            pointer-events: none;
        }

        #fullscreen-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 10000;
            overflow-y: scroll;
            cursor: zoom-out;
        }

        #home { text-decoration: none; color: black; }
        #fullscreen-viewer img { width: 100%; display: block; }

        @media (max-width: 768px) {
            #info { font-size: 24pt; top: 60px; max-width: 85%; }
            .info-desc { font-size: 11pt; }
            #filters {
                top: auto; bottom: 80px; left: 20px;
                transform: none; display: flex; flex-wrap: wrap;
                width: calc(100% - 40px);
            }
            .work-item { width: 180px; }
            header { width: 100%; left: 0; bottom: 0; padding: 5px 25px; box-sizing: border-box; }
        }

        /* --- OVERLAY wip --- */
#maintenance-overlay {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10001; /* Por encima de todo */    
    padding: 20px 40px;   
    text-align: center;
    
}

#maintenance-overlay p {
    font-family: "Times New Roman", Times, serif;
    font-size: 11pt;
    text-transform: lowercase;
}

.progress-container {
    width: 150px;
    height: 8px;
    border: 1px solid black;
    margin: 0 auto;
    position: relative;
    overflow: hidden;
}

.progress-bar {
    width: 30%; /* Progreso actual */
    height: 100%;
    background-color: #ff0000;
    
}

@keyframes loading {
    0% { transform: translateX(-100%); }
    50% { transform: translateX(150%); }
    100% { transform: translateX(-100%); }
}
    </style>
</head>
<body>

<canvas id="ivy-canvas"></canvas>

<div id="maintenance-overlay">
    <p>  coming soon(ish)</p>
    <div class="progress-container">
        <div class="progress-bar"></div>
    </div>
</div>
    
<div id="info"></div>
<!-- SISTEMA DE FILTROS 
<ul id="filters">
    <li class="active" data-filter="all">#all</li>
    <li data-filter="#editorial">#editorial</li>
    <li data-filter="#campaigns">#campaigns</li>
    <li data-filter="#film">#film</li>
    <li data-filter="#still-life">#still-life</li>
</ul>
-->
<div id="fullscreen-viewer"></div>

<header>
    <nav>
        <li><a href="index.html" id="home">Heura Murgui</a></li>
        <li><a href="works.html">works</a></li>
        <li><a href="contact.html">about</a></li>
        <li><a href="mailto:heuramurgui@gmail.com">heuramurgui (at) gmail (dot) com</a></li>
    </nav>
</header>

<main>
    <ul class="container-chaos" id="arena-container"></ul>
</main>

<script>
/* ==========================================
   LGICA DEL BACKGROUND
   ========================================== */
const canvas = document.getElementById('ivy-canvas');
const ctx = canvas.getContext('2d');
const pixelSize = 2;
const colors = {
    stem: '#4a6d55',
    flowers: ['#9cd888', '#9cd888', '#9cd888', '#9cd888'],
};
let plants = [];

class Stem {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.maxHeight = canvas.height * (0.6 + Math.random() * 0.35);
        this.currentHeight = 0;
        this.dead = false;
        this.spawnTime = Date.now() + Math.random() * 10000; 
        this.growthChance = 0.05 + Math.random() * 0.3; 
    }

    update(now) {
        if (now < this.spawnTime || this.dead) return;
        if (Math.random() < this.growthChance) {
            this.drawPixel(this.x, this.y, colors.stem);
            this.y -= pixelSize;
            this.x += (Math.random() - 0.5) * (pixelSize * 2.5);
            this.currentHeight += pixelSize;
            if (Math.random() > 0.97) this.drawFlower(false);
            if (this.currentHeight >= this.maxHeight) {
                this.dead = true;
                this.drawFlower(true);
            }
        }
    }

    drawPixel(x, y, color) {
        ctx.fillStyle = color;
        ctx.fillRect(Math.floor(x/pixelSize)*pixelSize, Math.floor(y/pixelSize)*pixelSize, pixelSize, pixelSize);
    }

    drawFlower(isFinal) {
        const color = colors.flowers[Math.floor(Math.random() * colors.flowers.length)];
        this.drawPixel(this.x + pixelSize, this.y, color);
        this.drawPixel(this.x - pixelSize, this.y, color);
        this.drawPixel(this.x, this.y - pixelSize, color);
        if(isFinal) {
            this.drawPixel(this.x + pixelSize, this.y - pixelSize, color);
            this.drawPixel(this.x - pixelSize, this.y - pixelSize, color);
            this.drawPixel(this.x, this.y - (pixelSize * 2), color);
        }
    }
}

function initBackground() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    plants = [];
    for (let i = 0; i < 40; i++) {
        plants.push(new Stem(Math.random() * canvas.width, canvas.height));
    }
}

function animateBackground() {
    const now = Date.now();
    plants.forEach(p => p.update(now));
    setTimeout(() => { requestAnimationFrame(animateBackground); }, 100); 
}

// Iniciar background
initBackground();
animateBackground();
window.addEventListener('resize', initBackground);


/*
   LGICA DE ARE.NA
   ========================================== */
$(function() {
    const CHANNEL_SLUG = 'prvw-cmmrcl';
    const API_BASE = 'https://api.are.na/v2';

    // (Aqu铆 va todo tu c贸digo JQuery original sin cambios...)
    $('#back-to-top').on('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Funci贸n para mezclar array
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Funci贸n para reubicar items (sin transiciones suaves)
    function repositionVisibleItems() {
        const $container = $('#arena-container');
        const windowWidth = $(window).width();
        const isMobile = windowWidth < 768;
        const itemWidth = isMobile ? 180 : 320;
        const spacing = isMobile ? 130 : 150;
        const variation = isMobile ? 50 : 80;
        
        // Obtener todos los items visibles
        const visibleItems = $('.work-item').filter(function() {
            return $(this).css('display') !== 'none';
        }).toArray();
        
        // Mezclar los items visibles
        const shuffled = shuffleArray(visibleItems);
        
        let maxBottom = 0;
        
        // Reubicar cada item
        shuffled.forEach((element, index) => {
            const $el = $(element);
            const sign = Math.random() < 0.5 ? '-' : '+';
            const posx = Math.random() * (windowWidth - itemWidth - 20);
            const posy = (index * spacing) + (Math.random() * variation);
            
            $el.css({
                'left': Math.max(10, posx) + 'px',
                'top': posy + 'px',
                'opacity': 1
            });
            
            const currentBottom = posy + 400;
            if (currentBottom > maxBottom) maxBottom = currentBottom;
        });
        
        // Actualizar altura del contenedor
        $container.css('height', (maxBottom + 200) + 'px');
    }

    // L贸gica de filtrado
    $('#filters li').on('click', function() {
        const filter = $(this).attr('data-filter').toLowerCase();
        $('#filters li').removeClass('active');
        $(this).addClass('active');

        if (filter === 'all') {
            $('.work-item').fadeIn(400);
        } else {
            $('.work-item').each(function() {
                const searchContent = ($(this).attr('data-search') || "").toLowerCase();
                if (searchContent.includes(filter)) {
                    $(this).fadeIn(400);
                } else {
                    $(this).fadeOut(400);
                }
            });
        }
        
        // Llamar repositioning despu茅s de que el fade complete
        setTimeout(repositionVisibleItems, 450);
    });

    function applyChaosLogic(element, index) {
        const $el = $(element);
        const windowWidth = $(window).width();
        const isMobile = windowWidth < 768;
        const sign = Math.random() < 0.5 ? '-' : '+';
        const itemWidth = isMobile ? 180 : 320;
        const posx = Math.random() * (windowWidth - itemWidth - 20);
        const spacing = isMobile ? 130 : 150;
        const variation = isMobile ? 50 : 80;
        const posy = (index * spacing) + (Math.random() * variation);

        $el.css({
            'left': Math.max(10, posx) + 'px',
            'top': posy + 'px',
            'opacity': 1
        });

        $el.draggable({ 
            stack: ".work-item", 
            revert: false, 
            revertDuration: 0,
            distance: 0,
            delay: 0
        });

        $el.hover(
            function() {
                const title = $(this).attr('data-title');
                const date = $(this).attr('data-date');
                const desc = $(this).attr('data-description');
                let infoHtml = `<div>${title} <span style="font-weight:400; font-size:0.4em;">(${date})</span></div>`;
                if (desc && desc !== "null" && desc !== "") infoHtml += `<div class="info-desc">${desc}</div>`;
                $('#info').html(infoHtml);
            },
            function() { $('#info').html(''); }
        );

        $el.on('click', function(e) {
            if ($(this).hasClass('ui-draggable-dragging')) return;
            const videoUrl = $(this).attr('data-video-url');
            window.open(videoUrl, '_blank');
        });
    }

    async function fetchArenaBlocks() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${API_BASE}/channels/${CHANNEL_SLUG}/contents?per=100&direction=desc&nocache=${timestamp}`);
            const data = await response.json();
            return data.contents.filter(block => block.class === 'Video');
        } catch (error) { return []; }
    }

    async function initArena() {
        const blocks = await fetchArenaBlocks();
        const $container = $('#arena-container');
        let maxBottom = 0;

        blocks.forEach((block, i) => {
            const thumbnailUrl = block.image ? block.image.display.url : block.source.url;
            const videoUrl = block.source ? block.source.url : block.embed_url;
            const title = block.title || "";
            const date = new Date(block.created_at).toLocaleDateString('es-ES', { year: 'numeric' });
            const description = block.description || "";

            // Intentamos extraer tags (si existen) y a帽adir versiones "normal" y con #
            let tagsArray = [];
            if (block.tags && Array.isArray(block.tags)) {
                tagsArray = block.tags.map(t => {
                    if (!t) return '';
                    if (typeof t === 'string') return t;
                    if (t.title) return t.title;
                    if (t.slug) return t.slug;
                    return '';
                }).filter(Boolean);
            }

            const hashtagString = tagsArray.map(t => {
                return ('#' + String(t).toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-#]/g, ''));
            }).join(' ');

            const megaSearch = `${title} ${description} ${tagsArray.join(' ')} ${hashtagString}`.toLowerCase();
            
            const html = `
                <li class="work-item" data-title="${title}" data-date="${date}" data-description="${description}" data-search="${megaSearch}" data-video-url="${videoUrl}">
                    <img class="thumb" src="${thumbnailUrl}" />
                </li>`;
            
            const $newItem = $(html);
            $container.append($newItem);
            applyChaosLogic($newItem, i);

            const currentBottom = parseFloat($newItem.css('top')) + 400;
            if (currentBottom > maxBottom) maxBottom = currentBottom;
        });
        $container.css('height', (maxBottom + 200) + 'px');
    }

    $('#fullscreen-viewer').on('click', function() {
        $(this).hide().empty();
        $('body').removeClass('lock-scroll');
        $('#info, #filters, #back-to-top').show();
    });

    initArena();
});
</script>

</body>
</html>
