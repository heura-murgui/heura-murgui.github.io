<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEURA MURGUI</title>
    <link rel="icon" href="assets/faviribbon.ico">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            font-family: "Times New Roman", Times, serif;
            font-size: 11pt;
            line-height: 1.1;
            overflow-x: hidden;
            scroll-behavior: smooth;
            text-transform: uppercase;
        }

        body.lock-scroll {
            overflow: hidden !important;
            height: 100vh !important;
        }

        /* SISTEMA DE FILTROS */
        #filters {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
            list-style: none;
            padding: 0;
            margin: 0;
            text-transform: lowercase;
        }

        #filters li {
            margin: 10px 0;
            font-size: 11pt;
            cursor: pointer;
            color: black;
        }

        #filters li:hover, #filters li.active {
            color: #ff0000;
            text-shadow: 1px 1px 1px #ff0000, 1px -1px 1px #ff0000, -1px 1px 1px #ff0000, -1px -1px 1px #ff0000;
        }

        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            font-size: 54pt;
            font-weight: 700;
            pointer-events: none;
            color: #ffffff;
            mix-blend-mode: difference;
            text-transform: none;
            max-width: 1000px;
            line-height: 1.1;
        }

        .info-desc {
            font-size: 14pt;
            font-weight: 400;
            margin-top: 8px;
            color: #ffffff;
        }

        #back-to-top {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            font-size: 11pt;
            color: black;
            cursor: pointer;
            text-transform: uppercase;
            background: red;
            border: none;
            padding: 5px 10px;
            font-family: inherit;
        }

        #back-to-top:hover { color: white; }

        header {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        nav li { list-style: none; margin: 0; padding: 0; }
        a { text-decoration: none; color: rgb(255, 0, 0); }
        a:hover { color: #ffffff; background-color: rgb(110, 108, 108); }

        .container-chaos {
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
            width: 100%;
        }

        .work-item {
            position: absolute;
            width: 320px;
            z-index: 10;
            opacity: 0; 
            cursor: zoom-in;
        }

        .thumb {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        #fullscreen-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 10000;
            overflow-y: scroll;
            cursor: zoom-out;
        }

        #home { text-decoration: none; color: black; }
        #fullscreen-viewer img { width: 100%; height: auto; display: block; }
        .ui-draggable-dragging { cursor: grabbing !important; }

        #ivy-canvas {
             position: absolute; /* Para que crezca con el scroll del contenedor */
             top: 0;
             left: 0;
             z-index: -1; /* Detrás de los videos y el menú */
             pointer-events: none; /* Para que no bloquee los clics en los videos */
             image-rendering: pixelated; /* Estética Sandspiel/Pixel Art */
        }

        @media (max-width: 768px) {
            #info { font-size: 24pt; top: 60px; max-width: 85%; }
            .info-desc { font-size: 11pt; }
            #filters {
                top: auto; bottom: 80px; left: 20px;
                transform: none; display: flex; flex-wrap: wrap;
                width: calc(100% - 40px);
            }
            #filters li { padding: 0px 4px; }
            .work-item { width: 180px; }
            header { width: 100%; left: 0; bottom: 0; padding: 5px 25px; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<canvas id="ivy-canvas"></canvas>
    
<div id="info"></div>

<div id="fullscreen-viewer"></div>

<header>
    <nav>
        <li><a href="index.html" id="home">Heura Murgui</a></li>
        <li><a href="works.html">works</a></li>
        <li><a href="about.html">about</a></li>
        <li><a href="mailto:heuramurgui@gmail.com">heuramurgui (at) gmail (dot) com</a></li>
    </nav>
</header>

<main>
    <ul class="container-chaos" id="arena-container"></ul>
</main>

<script>
$(function() {
    const CHANNEL_SLUG = 'a';
    const API_BASE = 'https://api.are.na/v2';

    // Botón volver arriba
    $('#back-to-top').on('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Lógica de filtrado
    $('#filters li').on('click', function() {
        const filter = $(this).attr('data-filter').toLowerCase();
        $('#filters li').removeClass('active');
        $(this).addClass('active');

        if (filter === 'all') {
            $('.work-item').fadeIn(400);
        } else {
            $('.work-item').each(function() {
                const searchContent = ($(this).attr('data-search') || "").toLowerCase();
                if (searchContent.includes(filter)) {
                    $(this).fadeIn(400);
                } else {
                    $(this).fadeOut(400);
                }
            });
        }
    });

    function applyChaosLogic(element, index) {
        const $el = $(element);
        const windowWidth = $(window).width();
        const isMobile = windowWidth < 768;
        const sign = Math.random() < 0.5 ? '-' : '+';
        const itemWidth = isMobile ? 180 : 320;
        const posx = Math.random() * (windowWidth - itemWidth - 20);
        const spacing = isMobile ? 130 : 150;
        const variation = isMobile ? 50 : 80;
        const posy = (index * spacing) + (Math.random() * variation);
        const rota = (Math.random() * 0).toFixed(2);

        $el.css({
            'left': Math.max(10, posx) + 'px',
            'top': posy + 'px',
            'transform': `rotate(${sign}${rota}deg)`,
            'opacity': 1
        });

        $el.draggable({ stack: ".work-item" });

        $el.hover(
            function() {
                const title = $(this).attr('data-title');
                const date = $(this).attr('data-date');
                const desc = $(this).attr('data-description');
                let infoHtml = `<div>${title} <span style="font-weight:400; font-size:0.4em;">(${date})</span></div>`;
                if (desc && desc !== "null" && desc !== "") infoHtml += `<div class="info-desc">${desc}</div>`;
                $('#info').html(infoHtml);
                $(this).css('z-index', '9000');
            },
            function() {
                $('#info').html('');
                $(this).css('z-index', '10');
            }
        );

        $el.on('click', function(e) {
            if ($(this).hasClass('ui-draggable-dragging')) return;
            const imgSrc = $(this).find('img').attr('src');
            $('#fullscreen-viewer').html(`<img src="${imgSrc}">`).show();
            $('body').addClass('lock-scroll');
            $('#info, #filters, #back-to-top').hide();
        });
    }

    async function fetchArenaBlocks() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${API_BASE}/channels/${CHANNEL_SLUG}/contents?per=100&direction=desc&nocache=${timestamp}`);
            const data = await response.json();
            return data.contents.filter(block => block.class === 'Image');
        } catch (error) {
            console.error('Error Are.na:', error);
            return [];
        }
    }

    async function init() {
        const blocks = await fetchArenaBlocks();
        const $container = $('#arena-container');
        let maxBottom = 0;

        blocks.forEach((block, i) => {
            const imageUrl = block.image.display.url;
            const title = block.title || "";
            const date = new Date(block.created_at).toLocaleDateString('es-ES', { year: 'numeric' });
            const description = block.description || "";
            
            // INTENTO AGRESIVO DE CAPTURA DE ALT TEXT
            // Probamos: campo directo, campo dentro de imagen o metadata
            const altText = block.alt_text || (block.image && block.image.alt_text) || "";
            
            // Creamos el campo de búsqueda sumando todo
            const megaSearch = `${title} ${description} ${altText}`.toLowerCase();
            
            const html = `
                <li class="work-item" 
                    data-title="${title}" 
                    data-date="${date}" 
                    data-description="${description}" 
                    data-search="${megaSearch}">
                    <img class="thumb" src="${imageUrl}" alt="${altText || title}" />
                </li>`;
            
            const $newItem = $(html);
            $container.append($newItem);
            applyChaosLogic($newItem, i);

            const currentBottom = parseFloat($newItem.css('top')) + 400;
            if (currentBottom > maxBottom) maxBottom = currentBottom;
        });

        $container.css('height', (maxBottom + 200) + 'px');
    }

    $('#fullscreen-viewer').on('click', function() {
        $(this).hide().empty();
        $('body').removeClass('lock-scroll');
        $('#info, #filters, #back-to-top').show();
    });

    init();
});


 const canvas = document.getElementById('ivy-canvas');
const ctx = canvas.getContext('2d');

let walkers = [];
let drawingActive = true;
let pixelsDrawn = 0;
const MAX_PIXELS = (window.innerWidth * document.documentElement.scrollHeight) * 0.05; // Detener al cubrir el 5% del área total

function initCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = document.documentElement.scrollHeight;
    ctx.globalAlpha = 0.7; // Opacidad del 70%
}

class IvyWalker {
    constructor(x, y) {
        this.x = x;
        this.y = y;
        this.color = '#ff0000'; // Rojo
        this.size = Math.random() * 2 + 1;
        this.angle = -Math.PI / 2; // Apunta hacia arriba (90 grados)
    }

    drawLeaf(x, y) {
        ctx.beginPath();
        ctx.ellipse(x, y, 4, 2, this.angle + Math.PI/2, 0, Math.PI * 2);
        ctx.fillStyle = '#cc0000';
        ctx.fill();
    }

    update() {
        if (!drawingActive) return;

        // Movimiento: Mucha más fuerza hacia arriba (-y) y poca lateral
        this.angle += (Math.random() - 0.5) * 0.3;
        this.x += Math.cos(this.angle) * 0.8; // Velocidad reducida
        this.y += Math.sin(this.angle) * 0.8 - 0.5; // Empuje extra hacia arriba

        // Dibujar tallo
        ctx.fillStyle = this.color;
        ctx.fillRect(this.x, this.y, this.size, this.size);
        pixelsDrawn++;

        // Dibujar hojas aleatoriamente
        if (Math.random() < 0.03) {
            this.drawLeaf(this.x, this.y);
            pixelsDrawn += 5;
        }

        // Ramificación sutil
        if (Math.random() < 0.01 && walkers.length < 40) {
            walkers.push(new IvyWalker(this.x, this.y));
        }

        // Detener si llegamos al límite de cobertura
        if (pixelsDrawn > MAX_PIXELS) {
            drawingActive = false;
            console.log("Crecimiento de hiedra completado.");
        }
    }
}

let lastTime = 0;
const fps = 30; // Control de velocidad: menos FPS = más lento

function animate(timestamp) {
    if (!drawingActive) return;

    // Controlar velocidad por tiempo
    if (timestamp - lastTime > 1000 / fps) {
        walkers.forEach((walker, index) => {
            walker.update();
            // Eliminar si sale de pantalla
            if (walker.y < 0 || walker.x < 0 || walker.x > canvas.width) {
                walkers.splice(index, 1);
            }
        });
        lastTime = timestamp;
    }
    
    if (walkers.length > 0) {
        requestAnimationFrame(animate);
    }
}

function startIvy() {
    initCanvas();
    // Inicia desde varios puntos en la base
    const numSeeds = 6;
    for(let i = 0; i < numSeeds; i++){
        walkers.push(new IvyWalker((canvas.width / numSeeds) * i + (Math.random() * 50), canvas.height));
    }
    requestAnimationFrame(animate);
}

$(window).on('load', function() {
    // Redimensionar si el usuario cambia el tamaño de la ventana
    $(window).on('resize', initCanvas);
    setTimeout(startIvy, 1500);
});
</script>

</body>
</html>