<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HEURA MURGUI</title>
    <link rel="icon" href="assets/faviribbon.ico">
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: #f4f4f4;
            font-family: "Times New Roman", Times, serif;
            font-size: 11pt;
            line-height: 1.1;
            overflow-x: hidden;
            scroll-behavior: smooth;
            text-transform: uppercase;
        }

        body.lock-scroll {
            overflow: hidden !important;
            height: 100vh !important;
        }

        /* SISTEMA DE FILTROS */
        #filters {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
            list-style: none;
            padding: 0;
            margin: 0;
            text-transform: lowercase;
        }

        #filters li {
            margin: 10px 0;
            font-size: 11pt;
            cursor: pointer;
            color: black;
        }

        #filters li:hover, #filters li.active {
            color: #ff0000;
            text-shadow: 1px 1px 1px #ff0000, 1px -1px 1px #ff0000, -1px 1px 1px #ff0000, -1px -1px 1px #ff0000;
        }

        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            font-size: 54pt;
            font-weight: 700;
            pointer-events: none;
            color: #ffffff;
            mix-blend-mode: difference;
            text-transform: none;
            max-width: 1000px;
            line-height: 1.1;
        }

        .info-desc {
            font-size: 14pt;
            font-weight: 400;
            margin-top: 8px;
            color: #ffffff;
        }

        #back-to-top {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            font-size: 11pt;
            color: black;
            cursor: pointer;
            text-transform: uppercase;
            background: red;
            border: none;
            padding: 5px 10px;
            font-family: inherit;
        }

        #back-to-top:hover { color: white; }

        #more {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            font-size: 11pt;
            color: black;
            cursor: pointer;
            text-transform: uppercase;
            background: red;
            padding: 5px 10px;
            font-family: inherit;
            display: inline-block;
            text-decoration: none;
        }

        #more:hover { color: white; background-color: red; }

        header {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        nav li { list-style: none; margin: 0; padding: 0; }
        a { text-decoration: none; color: rgb(255, 0, 0); }
        a:hover { color: #ffffff; background-color: rgb(110, 108, 108); }

        .container-chaos {
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
            width: 100%;
        }

        .work-item {
            position: absolute;
            width: 320px;
            z-index: 10;
            opacity: 0; 
            cursor: zoom-in;
        }

        .thumb {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }


        #home { text-decoration: none; color: black; }
        #fullscreen-viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.95);
            z-index: 100000;
            overflow: hidden;
            cursor: zoom-out;
            align-items: center;
            justify-content: center;
            display: none;
        }

        #fullscreen-viewer.show { display: flex; }

        #fullscreen-viewer img {
            max-width: 95vw;
            max-height: 95vh;
            width: auto;
            height: auto;
            display: block;
            object-fit: contain;
            transition: transform 220ms ease, opacity 220ms ease;
            cursor: zoom-out;
        }
        .ui-draggable-dragging { cursor: grabbing !important; }

        @media (max-width: 768px) {
            #info { font-size: 24pt; top: 60px; max-width: 85%; }
            .info-desc { font-size: 11pt; }
            #filters {
                top: auto; bottom: 80px; left: 20px;
                transform: none; display: flex; flex-wrap: wrap;
                width: calc(100% - 40px);
            }
            #filters li { padding: 0px 4px; }
            .work-item { width: 180px; }
            header { width: 100%; left: 0; bottom: 0; padding: 5px 25px; box-sizing: border-box; }
        }
    </style>
</head>
<body>

<div id="info"></div>

<ul id="filters">
    <li class="active" data-filter="all">#all</li>
    <li data-filter="#editorial">#editorial</li>
    <li data-filter="#campaigns">#campaigns</li>
    <li data-filter="#film">#film</li>
    <li data-filter="#still-life">#still-life</li>
</ul>

<button id="back-to-top">↑ back to top</button>
<a id="more" href="other.html">→ more</a>
<div id="fullscreen-viewer"></div>

<header>
    <nav>
        <li><a href="index.html" id="home">Heura Murgui</a></li>
        <li><a href="works.html">works</a></li>
        <li><a href="about.html">about</a></li>
        <li><a href="mailto:heuramurgui@gmail.com">heuramurgui (at) gmail (dot) com</a></li>
    </nav>
</header>

<main>
    <ul class="container-chaos" id="arena-container"></ul>
</main>

<script>
$(function() {
    const CHANNEL_SLUG = 'heura-murgui';
    const API_BASE = 'https://api.are.na/v2';

    // Botón volver arriba
    $('#back-to-top').on('click', function() {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    // Función para mezclar array
    function shuffleArray(array) {
        const shuffled = [...array];
        for (let i = shuffled.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
        }
        return shuffled;
    }

    // Función para reubicar items
    function repositionVisibleItems() {
        const $container = $('#arena-container');
        const windowWidth = $(window).width();
        const isMobile = windowWidth < 768;
        const itemWidth = isMobile ? 180 : 320;
        const spacing = isMobile ? 130 : 150;
        const variation = isMobile ? 50 : 80;
        
        // Obtener todos los items visibles
        const visibleItems = $('.work-item').filter(function() {
            return $(this).css('display') !== 'none';
        }).toArray();
        
        // Mezclar los items visibles
        const shuffled = shuffleArray(visibleItems);
        
        let maxBottom = 0;
        
        // Reubicar cada item
        shuffled.forEach((element, index) => {
            const $el = $(element);
            const sign = Math.random() < 0.5 ? '-' : '+';
            const posx = Math.random() * (windowWidth - itemWidth - 20);
            const posy = (index * spacing) + (Math.random() * variation);
            const rota = (Math.random() * 0).toFixed(2);
            
            $el.css({
                'left': Math.max(10, posx) + 'px',
                'top': posy + 'px',
                'transform': `rotate(${sign}${rota}deg)`,
                'opacity': 1,
                'transition': 'all 0.4s ease-in-out'
            });
            
            const currentBottom = posy + 400;
            if (currentBottom > maxBottom) maxBottom = currentBottom;
        });
        
        // Actualizar altura del contenedor
        $container.css('height', (maxBottom + 200) + 'px');
    }

    // Lógica de filtrado
    $('#filters li').on('click', function() {
        const filter = $(this).attr('data-filter').toLowerCase();
        $('#filters li').removeClass('active');
        $(this).addClass('active');

        if (filter === 'all') {
            $('.work-item').fadeIn(400);
        } else {
            $('.work-item').each(function() {
                const searchContent = ($(this).attr('data-search') || "").toLowerCase();
                if (searchContent.includes(filter)) {
                    $(this).fadeIn(400);
                } else {
                    $(this).fadeOut(400);
                }
            });
        }
        
        // Llamar repositioning después de que el fade complete
        setTimeout(repositionVisibleItems, 450);
    });

    function applyChaosLogic(element, index) {
        const $el = $(element);
        const windowWidth = $(window).width();
        const isMobile = windowWidth < 768;
        const sign = Math.random() < 0.5 ? '-' : '+';
        const itemWidth = isMobile ? 180 : 320;
        const posx = Math.random() * (windowWidth - itemWidth - 20);
        const spacing = isMobile ? 130 : 150;
        const variation = isMobile ? 50 : 80;
        const posy = (index * spacing) + (Math.random() * variation);
        const rota = (Math.random() * 0).toFixed(2);

        $el.css({
            'left': Math.max(10, posx) + 'px',
            'top': posy + 'px',
            'transform': `rotate(${sign}${rota}deg)`,
            'opacity': 1
        });

        $el.draggable({ 
            stack: ".work-item", 
            revert: false, 
            revertDuration: 0,
            distance: 0,
            delay: 0,
            start: function() {
                const $t = $(this);
                // store any existing transition so we can restore it after drag
                $t.data('prev-transition', $t.css('transition') || '');
                // disable CSS transitions during drag for 1:1 movement
                $t.css('transition', 'none');
            },
            stop: function() {
                const $t = $(this);
                const prev = $t.data('prev-transition');
                // restore previous transition (or leave empty)
                if (typeof prev !== 'undefined' && prev !== null) {
                    $t.css('transition', prev);
                } else {
                    $t.css('transition', '');
                }
            }
        });

        $el.hover(
            function() {
                const title = $(this).attr('data-title');
                const date = $(this).attr('data-date');
                const desc = $(this).attr('data-description');
                let infoHtml = `<div>${title} <span style="font-weight:400; font-size:0.4em;">(${date})</span></div>`;
                if (desc && desc !== "null" && desc !== "") infoHtml += `<div class="info-desc">${desc}</div>`;
                $('#info').html(infoHtml);
                $(this).css('z-index', '9000');
            },
            function() {
                $('#info').html('');
                $(this).css('z-index', '10');
            }
        );

        $el.on('click', function(e) {
            if ($(this).hasClass('ui-draggable-dragging')) return;
            const imgSrc = $(this).find('img').attr('src');
            $('#fullscreen-viewer').html(`<img src="${imgSrc}">`).addClass('show');
            $('body').addClass('lock-scroll');
            $('#info, #filters, #back-to-top').hide();
        });
    }

    async function fetchArenaBlocks() {
        try {
            const timestamp = new Date().getTime();
            const response = await fetch(`${API_BASE}/channels/${CHANNEL_SLUG}/contents?per=100&direction=desc&nocache=${timestamp}`);
            const data = await response.json();
            return data.contents.filter(block => block.class === 'Image');
        } catch (error) {
            console.error('Error Are.na:', error);
            return [];
        }
    }

    async function init() {
        const blocks = await fetchArenaBlocks();
        const $container = $('#arena-container');
        let maxBottom = 0;

        blocks.forEach((block, i) => {
            const imageUrl = block.image.display.url;
            const title = block.title || "";
            const date = new Date(block.created_at).toLocaleDateString('es-ES', { year: 'numeric' });
            const description = block.description || "";
            
            // INTENTO AGRESIVO DE CAPTURA DE ALT TEXT
            // Probamos: campo directo, campo dentro de imagen o metadata
            const altText = block.alt_text || (block.image && block.image.alt_text) || "";

            // Intentamos extraer tags (si existen) y añadir versiones "normal" y con #
            let tagsArray = [];
            if (block.tags && Array.isArray(block.tags)) {
                tagsArray = block.tags.map(t => {
                    if (!t) return '';
                    if (typeof t === 'string') return t;
                    if (t.title) return t.title;
                    if (t.slug) return t.slug;
                    return '';
                }).filter(Boolean);
            }

            const hashtagString = tagsArray.map(t => {
                return ('#' + String(t).toLowerCase().trim().replace(/\s+/g, '-').replace(/[^\w\-#]/g, ''));
            }).join(' ');

            // Creamos el campo de búsqueda sumando todo, incluyendo tags y hashtags
            const megaSearch = `${title} ${description} ${altText} ${tagsArray.join(' ')} ${hashtagString}`.toLowerCase();
            
            const html = `
                <li class="work-item" 
                    data-title="${title}" 
                    data-date="${date}" 
                    data-description="${description}" 
                    data-search="${megaSearch}">
                    <img class="thumb" src="${imageUrl}" alt="${altText || title}" />
                </li>`;
            
            const $newItem = $(html);
            $container.append($newItem);
            applyChaosLogic($newItem, i);

            const currentBottom = parseFloat($newItem.css('top')) + 400;
            if (currentBottom > maxBottom) maxBottom = currentBottom;
        });

        $container.css('height', (maxBottom + 200) + 'px');
    }

    // Close viewer when clicking anywhere (including the image)
    $('#fullscreen-viewer').on('click', function() {
        const $v = $(this);
        $v.removeClass('show');
        setTimeout(() => { $v.empty(); }, 240);
        $('body').removeClass('lock-scroll');
        $('#info, #filters, #back-to-top').show();
    });

    init();
});
</script>

</body>
</html>