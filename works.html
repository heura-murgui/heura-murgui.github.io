<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HM</title>
    <link rel="icon" href="assets/faviribbon.ico">
    
    <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui-touch-punch/0.2.3/jquery.ui.touch-punch.min.js"></script>

    <style>
        html, body {
            margin: 0;
            padding: 0;
            background-color: #ffffff;
            font-family: "Times New Roman", Times, serif;
            overflow-x: hidden;
            scroll-behavior: smooth;
            text-transform: uppercase;
        }

        body.lock-scroll {
            overflow: hidden !important;
            height: 100vh !important; 
        }

        #filters {
            position: fixed;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            z-index: 9999;
            list-style: none;
            padding: 0;
            margin: 0;
            text-transform: lowercase;
        }

        #filters li {
            margin: 10px 0;
            font-size: 11pt;
            cursor: pointer;
            color: black;
        }

        #filters li:hover, #filters li.active {
            color: #ff0000;
            text-shadow: 1px 1px 1px #ff0000, 1px -1px 1px #ff0000, -1px 1px 1px #ff0000, -1px -1px 1px #ff0000;
        } 

        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 9998;
            font-size: 54pt;
            font-weight: 700;
            pointer-events: none;
            color: #1a1a1a;
            text-transform: lowercase;
            max-width: 1000px;
            line-height: 1.1;
        }

        .info-desc {
            font-size: 14pt;
            font-weight: 400;
            margin-top: 8px;
            color: #444;
        }

        #back-to-top {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            font-size: 11pt;
            color: black;
            cursor: pointer;
            text-transform: uppercase;
            background: red;
            border: none;
            padding: 5px 10px;
            font-family: inherit;
        }

        header {
            position: fixed;
            bottom: 20px;
            left: 20px;
            z-index: 9999;
        }

        nav li { list-style: none; margin: 0; padding: 0; }
        a { text-decoration: none; color: rgb(255, 0, 0); }
        a:hover { color: #ffffff; background-color: rgb(110, 108, 108); }

        .container-chaos {
            list-style: none;
            margin: 0;
            padding: 0;
            position: relative;
            width: 100%;
        }

        .work-item {
            position: absolute;
            width: 320px;
            z-index: 10;
            opacity: 0; 
            cursor: zoom-in;
        }

        .thumb {
            width: 100%;
            height: auto;
            display: block;
            pointer-events: none;
        }

        #fullscreen-viewer {
            display: none; 
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            z-index: 10000;
            overflow-y: scroll; 
            cursor: zoom-out;
        }

        #home { text-decoration: none; color: black; }
        #fullscreen-viewer img { width: 100%; height: auto; display: block; }
        .ui-draggable-dragging { cursor: grabbing !important; }
    </style>
</head>
<body>

    <div id="info"></div>
    
    <ul id="filters">
        <li class="active" data-filter="all">#all</li>
        <li data-filter="#35mm">#35mm</li>
        <li data-filter="#editorial">#editorial</li>
        <li data-filter="#fashion">#fashion</li>
        <li data-filter="#product">#product</li>
    </ul>

    <button id="back-to-top">↑ back to top</button>

    <div id="fullscreen-viewer"></div>

    <header>
        <nav>
            <li><a href="index.html" id="home">Heura Murgui</a></li>
            <li><a href="works.html">works</a></li>
            <li><a href="about.html">about</a></li>
            <li><a href="mailto:heuramurgui@gmail.com">heuramurgui (at) gmail (dot) com</a></li>
        </nav>
    </header>

    <main>
        <ul class="container-chaos" id="arena-container"></ul>
    </main>

    <script>
    $(function() {
        const CHANNEL_SLUG = 'angela-test'; 
        const API_BASE = 'https://api.are.na/v2';

        $('#back-to-top').on('click', function() {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });

        // Función de posicionamiento reutilizable
        function positionElement(element, index) {
            const $el = $(element);
            const sign = Math.random() < 0.5 ? '-' : '+';
            const posx = Math.random() * ($(window).width() - 350);
            
            // Posición vertical basada en el índice actual del filtro
            const baseTop = index * 300; 
            const randomVariation = Math.random() * 250; 
            const posy = baseTop + randomVariation;
            const rota = (Math.random() * 15).toFixed(2);

            $el.css({
                'left': posx + 'px',
                'top': posy + 'px',
                'transform': `rotate(${sign}${rota}deg)`,
                'opacity': 1
            });

            return posy;
        }

        // Lógica de filtrado con reordenación arriba
        $('#filters li').on('click', function() {
            const filter = $(this).attr('data-filter');
            $('#filters li').removeClass('active');
            $(this).addClass('active');

            let visibleCount = 0;
            let maxBottom = 0;

            $('.work-item').each(function() {
                const $item = $(this);
                const itemTags = $item.attr('data-tags') || "";

                if (filter === 'all' || itemTags.includes(filter)) {
                    $item.show();
                    // Reposicionamos usando el contador de visibles actual
                    const currentTop = positionElement($item, visibleCount);
                    if (currentTop + 400 > maxBottom) maxBottom = currentTop + 400;
                    visibleCount++;
                } else {
                    $item.hide();
                }
            });

            $('#arena-container').css('height', (maxBottom + 400) + 'px');
            window.scrollTo({ top: 0, behavior: 'instant' });
        });

        async function fetchArenaBlocks() {
            try {
                const response = await fetch(`${API_BASE}/channels/${CHANNEL_SLUG}/contents?per=50&direction=desc`);
                const data = await response.json();
                return data.contents.filter(block => block.class === 'Image');
            } catch (error) {
                console.error('Error:', error);
                return [];
            }
        }

        function applyInteractions($el) {
            $el.draggable({ stack: ".work-item" });

            $el.hover(
                function() { 
                    const title = $(this).attr('data-title');
                    const date = $(this).attr('data-date');
                    const desc = $(this).attr('data-description');
                    let infoHtml = `<div>${title} <span style="font-weight:400; font-size:18pt;">(${date})</span></div>`;
                    if (desc && desc !== "null") infoHtml += `<div class="info-desc">${desc}</div>`;
                    $('#info').html(infoHtml);
                    $(this).css('z-index', '9000');
                }, 
                function() { 
                    $('#info').html('');
                    $(this).css('z-index', '10');
                }
            );

            $el.on('click', function() {
                if ($(this).hasClass('ui-draggable-dragging')) return;
                const imgSrc = $(this).find('img').attr('src');
                $('#fullscreen-viewer').html(`<img src="${imgSrc}">`).show();
                $('body').addClass('lock-scroll');
                $('#info, #filters, #back-to-top').hide();
            });
        }

        $('#fullscreen-viewer').on('click', function() {
            $(this).hide().empty();
            $('body').removeClass('lock-scroll');
            $('#info, #filters, #back-to-top').show();
        });

        async function init() {
            const blocks = await fetchArenaBlocks();
            const $container = $('#arena-container');
            let maxBottom = 0;

            blocks.forEach((block, i) => {
                const imageUrl = block.image.display.url;
                const title = block.title || "untitled";
                const altText = block.image.alt || ""; // Leemos de Alt Text
                const date = new Date(block.created_at).toLocaleDateString('en-EN', { year: 'numeric', month: 'numeric', day: 'numeric' });
                const description = block.description || "";
                
                const html = `
                    <li class="work-item" 
                        data-title="${title}" 
                        data-date="${date}" 
                        data-description="${description}"
                        data-tags="${altText}"> 
                        <img class="thumb" src="${imageUrl}" alt="${title}" />
                    </li>
                `;
                
                const $newItem = $(html);
                $container.append($newItem);
                applyInteractions($newItem);
                
                const currentTop = positionElement($newItem, i);
                if (currentTop + 400 > maxBottom) maxBottom = currentTop + 400;
            });

            $container.css('height', (maxBottom + 400) + 'px');
        }

        init();
    });
    </script>
</body>
</html>